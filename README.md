# VideoCompressorServiceの概要

## 推奨使用言語：Python（サーバとクライアント両方で）

## 内容

### このステージでは、ユーザーが動画ファイルをサーバにアップロードし、そのファイルに対して動画処理ができるサービスを開発します。処理が完了した動画ファイルはサーバからユーザーに返されます。サーバとクライアントは、TCP とカスタムアプリケーションレベルプロトコルを使って、さまざまな種類のファイルを互いに送信できるようにします。以下に、このサービスで提供される動画処理機能の一覧があります

### 動画を圧縮する: <br>ユーザーは動画ファイルをサーバにアップロードし、圧縮されたバージョンをダウンロードできます。サーバが自動的に最適な圧縮を選択します

### 動画の解像度を変更する: <br>ユーザーが動画をアップロードして希望する解像度を選択すると、その解像度に変更された動画がダウンロードできます

### 動画のアスペクト比を変更する: <br>ユーザーが動画をアップロードして希望するアスペクト比を選ぶと、そのアスペクト比に変更された動画がダウンロードできます

### 動画を音声に変換する: <br>動画ファイルをアップロードすると、その動画から音声だけを抽出した MP3 バージョンがダウンロードできます

### 指定した時間範囲で GIF や WEBM を作成: <br>ユーザーが動画をアップロードし、時間範囲を指定すると、その部分を切り取って GIF または WEBM フォーマットに変換します

### すべての動画処理は FFMPEG を使って行います

> FFMPEG は無料のオープンソースのソフトウェアプロジェクトであり、マルチメディアファイルを扱うためのツールとライブラリ、およびオーディオや動画ファイルを変換・処理するコマンドラインユーティリティを提供しています。さまざまなファイル形式間での変換はもちろん、動画のカット、リサイズ、エフェクト追加など、多くの操作が可能です。このソフトウェアはメディアやエンターテイメント業界で広く採用されており、多様なオペレーティングシステムやプラットフォームで利用できます。
>
## 機能要件

### クライアントとサーバが通信できるように、カスタムアプリケーションレベルプロトコルを設計します。TCP コネクション は UDP と比べて信頼性が高く、初期のハンドシェイクや余計なオーバーヘッドがありますが、メッセージの受信順序が保証されます。以下のカスタムプロトコルを **Multiple Media Protocol（MMP）** と呼びます

## ヘッダー（64 ビット）: <br>JSONサイズ（2バイト）、メディアタイプサイズ（1バイト）、ペイロードサイズ（5 バイト）を含みます

## ボディ：<br>最初の JSON サイズバイトは、すべての引数を含む JSON ファイルで、最大で 216バイト（64 KB）です。次のメディアタイプサイズバイトは、メディアタイプ（mp4、mp3、json、avi など）です。メディアタイプは UTF-8 でエンコードされ、1~4 バイトの幅を持つことができます。その後にペイロードが続き、そのサイズはペイロードサイズバイトで、最大 240 バイト(1TB)です。ペイロードは常にファイルとして格納され、メディアタイプに基づいたファイルタイプを持ち、メディアタイプに従って読み込まれることに注意しましょう

### サーバは、ペイロードを保存した後で、JSON ファイルを読み込んでリクエストを処理します

### クライアントとサーバは、データの送受信に同じプロトコルを使用します

### 何らかのエラーが発生した場合、エラーコード、説明、解決策を含む JSON ファイルが送信されます。この場合、メディアサイズとペイロードサイズは両方とも 0 に設定されます

### クライアントがサーバからファイルをダウンロードしていない間、定期的に動画ファイルの処理状況を確認します。デフォルトの確認間隔は 1 分です

## 特徴

### サーバは、すべての動画メディア処理に FFMPEG を使用します

### このサービスは、FFMPEG が対応している全てのフォーマットをサポートします。詳細は FFMPEG のフォーマット（muxerとdemuxer）を参照してください

### 全てのファイルは一時的に保存され、処理完了後にはサーバに保存されたファイルはストレージから削除されます

### サーバは IP アドレスごとに処理を 1 つに制限します

### 動画ファイルの圧縮<br>このサービスは動画ファイルをユーザーに代わって圧縮し、自動的に最適な圧縮方法を選びます。サービスは、大きなファイルサイズの削減を実現しながらも、オリジナルに近い画質を維持した動画を返す必要があります

### 動画の解像度の変更<br>ユーザーが動画をアップロードし、望む解像度を選ぶと、その解像度に変換された動画が返されます

### 動画のアスペクト比の変更<br>ユーザーが動画をアップロードし、望むアスペクト比を選ぶと、そのアスペクト比に変換された動画が返されます

### 動画をオーディオに変換<br>ユーザーが動画ファイルをアップロードすると、その動画から音声だけを抽出した MP3 バージョンが返されます

### 時間範囲での GIF と WEBM の作成<br>ユーザーが動画をアップロードし、時間範囲を指定すると、その部分を切り取り、GIF または WEBM 形式に変換して返します

#### 非機能要件<br>ファイルアップロードシステムは、ファイルが破損せずに完全に送られることを最優先としなければいけません。ファイルが完全に送信される、もしくはアップロードが中止されて保存されない、という状態のどちらかでなければならない。この要件は TCP とデータサイズの設定によって達成されます。<br>ファイルアップロードサーバは、一台のサーバで最大で 4TB のデータを保存できます。全てのユーザーファイルは一時的に保管され、速やかに削除される必要があります。<br>各ファイルシステムサーバは、少なくとも毎秒 5,000 個の 1,400 バイトのパケットを処理する能力が必要です。そして、常時、リソースの 60% 以上を動画処理に割り当てる必要があります
