# VideoCompressorService ユーザーガイド

## 概要

VideoCompressorServiceは、動画ファイルをアップロードして様々な処理を行うことができるクライアント・サーバーアプリケーションです。このサービスは、クライアントとサーバー間の信頼性の高い通信のために、TCP上でカスタムバイナリプロトコル（MMP - Multiple Media Protocol）を使用しています。

## 機能

このサービスは以下の動画処理機能をサポートしています：

1. **圧縮** - 自動品質最適化により動画ファイルサイズを削減
2. **解像度変更** - 標準フォーマットへの動画解像度変更
3. **アスペクト比変更** - レターボックスまたはストレッチモードでのアスペクト比変更
4. **音声抽出** - 動画から音声を抽出してMP3として保存
5. **クリップ作成** - 特定の時間範囲からGIFまたはWEBMクリップを生成

すべての動画処理はFFmpegを使用して実行され、FFmpegがサポートするすべてのフォーマットに対応しています。

## 必要要件

### システム要件

- Python 3.10以上
- FFmpegがインストールされ、システムPATHで利用可能であること

### Python依存関係

- asyncio（組み込み）
- 標準ライブラリモジュール：json、os、datetime、subprocess

### FFmpegのインストール

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

**Windows:**
[ffmpeg.org](https://ffmpeg.org/download.html)からダウンロードし、PATHに追加してください。

インストールの確認：
```bash
ffmpeg -version
```

## セットアップ

### 1. リポジトリのクローンまたはダウンロード

```bash
git clone <repository-url>
cd VideoCompressorService_ver2
```

### 2. ファイルの確認

以下のファイルが存在することを確認してください：
- `server.py` - サーバーアプリケーション
- `client.py` - クライアントアプリケーション
- `mmp_protocol.py` - プロトコル実装
- `ffmpeg_function.py` - 動画処理関数

### 3. 接続設定（オプション）

デフォルトでは、サービスは以下を使用します：
- ホスト：`127.0.0.1`（localhost）
- ポート：`8888`

これらの設定を変更するには、`client.py`と`server.py`の両方の`__init__`メソッドを編集してください：

```python
self.host = "127.0.0.1"  # 希望のホストに変更
self.port = 8888         # 希望のポートに変更
```

## 使用方法

### サーバーの起動

1. ターミナルを開き、プロジェクトディレクトリに移動します
2. サーバーを起動します：

```bash
python server.py
```

以下のように表示されます：
```
サーバー起動： ip 127.0.0.1 port 8888
```

サーバーは実行を続け、クライアント接続を待機します。このターミナルは開いたままにしてください。

### クライアントの実行

1. **新しいターミナル**を開きます（最初のターミナルでサーバーを実行したまま）
2. プロジェクトディレクトリに移動します
3. クライアントを実行します：

```bash
python client.py
```

### クライアントインターフェースの使用

クライアントは操作を選択するための対話型メニューを提供します：

```
=== 処理を選択してください ===
1. 圧縮(compress)
2. 解像度変更(resize)
3. アスペクト比変更(aspect)
4. 音声抽出(convert)
5. GIF/WEBM作成(trim)
```

## 操作の詳細

### 1. 動画の圧縮

**目的：** 良好な品質を維持しながら動画ファイルサイズを削減します。

**手順：**
1. メニューからオプション`1`を選択
2. 動画ファイルのパスを入力
3. 処理が完了するまで待機

**例：**
```
番号を入力してください (1-5): 1
ファイルパスを入力してください: /path/to/video.mp4
```

**出力：** 圧縮された動画が`./response_data/compress_video_TIMESTAMP.mp4`に保存されます

**技術詳細：**
- CRF 28のH.264コーデックを使用
- ファイルサイズを最大化するために音声は削除されます
- ファイルサイズ削減のために自動的に最適化されます

### 2. 動画解像度の変更

**目的：** 動画の寸法を標準解像度に変更します。

**手順：**
1. メニューからオプション`2`を選択
2. 動画ファイルのパスを入力
3. ターゲット解像度を選択：
   - `1` - 1920x1080（フルHD）
   - `2` - 1280x720（HD）
   - `3` - 640x480（SD）

**例：**
```
番号を入力してください (1-5): 2
ファイルパスを入力してください: /path/to/video.mp4

===解像度を選択してください
1. 1900*1080
2. 1280*720
3. 640*480

番号を入力してください (1-3): 2
```

**出力：** リサイズされた動画が`./response_data/resize_video_TIMESTAMP.mp4`に保存されます

### 3. アスペクト比の変更

**目的：** 異なるフィッティングモードで動画のアスペクト比を変更します。

**手順：**
1. メニューからオプション`3`を選択
2. 動画ファイルのパスを入力
3. ターゲットアスペクト比を選択：
   - `1` - 16:9（ワイドスクリーン）
   - `2` - 4:3（標準）
   - `3` - 1:1（正方形）
4. フィットモードを選択：
   - `1` - レターボックス（黒い余白を追加し、元のコンテンツを保持）
   - `2` - ストレッチ（フレームに合わせて歪める）

**例：**
```
番号を入力してください (1-5): 3
ファイルパスを入力してください: /path/to/video.mp4

===アスペクト比を選択してください
1. 16:9
2. 4:3
3. 1:1

番号を入力してください (1-3): 1

===フィット方法を選択してください
1. letterbox: 元の映像を維持し、余白を黒で埋める
2. stretch: 元の映像を引き延ばして目標アスペクト比に合わせる

番号を入力してください (1-2): 1
```

**出力：** 変更された動画が`./response_data/aspect_video_TIMESTAMP.mp4`に保存されます

### 4. 動画を音声に変換（MP3）

**目的：** 動画から音声トラックを抽出してMP3として保存します。

**手順：**
1. メニューからオプション`4`を選択
2. 動画ファイルのパスを入力
3. 処理が完了するまで待機

**例：**
```
番号を入力してください (1-5): 4
ファイルパスを入力してください: /path/to/video.mp4
```

**出力：** 音声ファイルが`./response_data/convert_video_TIMESTAMP.mp3`に保存されます

**技術詳細：**
- libmp3lameコーデックを使用
- 元の音声品質を維持

### 5. GIFまたはWEBMクリップの作成

**目的：** 動画の一部を抽出してGIFまたはWEBM形式に変換します。

**手順：**
1. メニューからオプション`5`を選択
2. 動画ファイルのパスを入力
3. 出力形式を選択：
   - `1` - GIF
   - `2` - WEBM
4. 開始時間を入力（形式：`HH:MM:SS`または秒数）
5. 継続時間を入力（形式：`HH:MM:SS`または秒数）

**例：**
```
番号を入力してください (1-5): 5
ファイルパスを入力してください: /path/to/video.mp4

===GIF or WEBMを選択してください
1. GIF
2. WEBM

番号を入力してください (1-2): 1

切り取りを始める開始時間を入力してください。(例: 00:00:10 または 10): 10

切り取り時間を入力してください。(例: 00:00:5 または 5): 5
```

**出力：** クリップが`./response_data/trim_video_TIMESTAMP.gif`または`.webm`に保存されます

**技術詳細：**
- GIF：10 fps、幅320pxにスケール（アスペクト比を維持）
- WEBM：CRF 30のVP9コーデックを使用

## ファイルの場所

### 入力ファイル

動画ファイルはシステム上のどこにでも配置できます。プロンプトが表示されたら、ファイルへの完全パスまたは相対パスを指定してください。

**例：**
- 絶対パス：`/home/user/videos/sample.mp4`
- 相対パス：`./videos/sample.mp4`
- 現在のディレクトリ：`sample.mp4`

### 出力ファイル

すべての処理済みファイルは、`client.py`と同じ場所に自動的に作成される`./response_data/`ディレクトリに自動的に保存されます。

**出力ファイルの命名パターン：**
- 圧縮：`compress_video_YYYYMMDD_HHMMSS.mp4`
- 解像度変更：`resize_video_YYYYMMDD_HHMMSS.mp4`
- アスペクト比：`aspect_video_YYYYMMDD_HHMMSS.mp4`
- 音声変換：`convert_video_YYYYMMDD_HHMMSS.mp3`
- クリップ作成：`trim_video_YYYYMMDD_HHMMSS.gif`または`.webm`

### 一時ファイル

サーバーは、アップロードされたファイルと処理済みファイルを`./upload/`ディレクトリに一時的に保存します。これらのファイルは、レスポンスがクライアントに送信された後、自動的に削除されます。

## サポートされているファイル形式

このサービスは、FFmpegがサポートするすべての動画形式をサポートしています：

**動画形式：**
- MP4（.mp4）
- AVI（.avi）
- MOV（.mov）
- MKV（.mkv）
- FLV（.flv）
- WMV（.wmv）
- その他多数

**出力形式：**
- 動画：MP4
- 音声：MP3
- クリップ：GIF、WEBM

## トラブルシューティング

### サーバーが起動しない

**問題：** `Address already in use`エラー

**解決策：** 別のプロセスがポート8888を使用しています。次のいずれかを実行してください：
1. 他のプロセスを停止する
2. `server.py`と`client.py`の両方でポートを変更する

### クライアントが接続できない

**問題：** `Connection refused`エラー

**解決策：**
1. サーバーが実行されていることを確認する
2. クライアントとサーバーの両方でホストとポートが一致していることを確認する
3. リモート接続を使用している場合は、ファイアウォール設定を確認する

### ファイルが見つからないエラー

**問題：** クライアントがファイルが存在しないと報告する

**解決策：**
1. ファイルパスが正しいことを確認する
2. 相対パスが機能しない場合は絶対パスを使用する
3. ファイルのアクセス権限を確認する

### FFmpegエラー

**問題：** FFmpegエラーで処理が失敗する

**解決策：**
1. FFmpegがインストールされていることを確認：`ffmpeg -version`
2. 入力ファイルが破損していないことを確認する
3. ファイル形式がサポートされていることを確認する
4. 詳細なエラーメッセージについてはサーバーターミナルを確認する

### 処理に時間がかかりすぎる

**問題：** 動画処理が非常に遅い

**解決策：**
- 大きなファイルは処理に時間がかかります
- 圧縮と解像度変更はCPU集約的です
- テストには小さなファイルの使用を検討してください
- システムリソース（CPU、メモリ）を確認してください

### 出力ファイルの品質の問題

**問題：** 圧縮された動画の品質が悪い

**解決策：**
- 圧縮はサイズと品質のバランスを取るためにCRF 28を使用しています
- より高い品質が必要な場合は、`ffmpeg_function.py`のFFmpegパラメータを変更する必要があります

## 高度な設定

### FFmpegパラメータの変更

動画処理パラメータをカスタマイズするには、`ffmpeg_function.py`の関数を編集してください：

**例 - 圧縮品質の変更：**
```python
# compress_video_file関数内
# CRF値を変更（低い値 = 高品質、大きなファイル）
"-crf", "28",  # より高品質にするには"23"に変更
```

### 異なるマシンでの実行

サーバーを1台のマシンで実行し、クライアントを別のマシンで実行するには：

1. **サーバーマシン上：**
   - すべてのインターフェースにバインドするように`server.py`を編集：
     ```python
     self.host = "0.0.0.0"
     ```
   - サーバーのIPアドレスをメモする

2. **クライアントマシン上：**
   - サーバーのIPで`client.py`を編集：
     ```python
     self.host = "192.168.1.100"  # サーバーのIPアドレス
     ```

3. ファイアウォールがポート8888での接続を許可していることを確認する

## プロトコル情報（MMP）

このサービスは通信にカスタムMultiple Media Protocol（MMP）を使用します：

**ヘッダー（8バイト）：**
- JSONサイズ（2バイト） - JSONメタデータのサイズ
- メディアタイプサイズ（1バイト） - メディアタイプ文字列のサイズ
- ペイロードサイズ（5バイト） - ファイルデータのサイズ

**ボディ（可変）：**
- JSONデータ - 操作の指示とパラメータ
- メディアタイプ - ファイル形式（例："video/mp4"）
- ペイロード - バイナリファイルデータ

**最大サイズ：**
- JSON：65,535バイト（64 KB）
- メディアタイプ：255バイト
- ペイロード：1,099,511,627,775バイト（約1 TB）

## セキュリティに関する考慮事項

1. **ローカル使用のみ：** デフォルトでは、サーバーはlocalhost（127.0.0.1）からの接続のみを受け入れます
2. **認証なし：** このサービスは認証を実装していません。信頼できないネットワークに公開しないでください
3. **一時ストレージ：** すべてのファイルは処理後に削除されます
4. **ファイルサイズ制限：** 大きなファイルを処理する際はディスク容量に注意してください

## パフォーマンスに関する注意事項

- サーバーは複数の操作を順次処理できます
- 各操作はブロッキングを避けるために別のスレッドで実行されます
- 処理時間は以下に依存します：
  - ファイルサイズ
  - 動画解像度
  - 操作タイプ
  - システムCPUパフォーマンス

## サービスの停止

### クライアントの停止

クライアントは各操作の完了後に自動的に切断されます。

### サーバーの停止

サーバーターミナルで`Ctrl+C`を押してください：
```
^C
サーバーを停止しました
```

## 使用例のワークフロー

動画を圧縮する完全な例：

1. **サーバーを起動：**
   ```bash
   python server.py
   ```
   出力：`サーバー起動： ip 127.0.0.1 port 8888`

2. **クライアントを実行（新しいターミナルで）：**
   ```bash
   python client.py
   ```

3. **圧縮操作を選択：**
   ```
   番号を入力してください (1-5): 1
   ```

4. **ファイルパスを入力：**
   ```
   ファイルパスを入力してください: ./my_video.mp4
   ```

5. **処理を待機：**
   ```
   サーバーに接続中 host: 127.0.0.1 port: 8888
   サーバーとの疎通確認が完了しました。
   リクエスト送信完了
   レスポンスデータの受信完了
   圧縮ファイルを ./response_data/compress_video_20231027_153045.mp4 へ保存しました
   ```

6. **処理済み動画を確認：**
   ```bash
   ls ./response_data/
   ```

## ヘルプの入手

このガイドでカバーされていない問題が発生した場合：

1. 詳細なエラーメッセージについてはサーバーターミナルを確認してください
2. すべての要件が正しくインストールされていることを確認してください
3. まず小さくてシンプルな動画ファイルでテストしてください
4. FFmpegが動作していることを確認：`ffmpeg -version`

## ライセンスとクレジット

このサービスはすべての動画処理操作にFFmpegを使用しています。FFmpegは設定に応じてLGPLまたはGPLの下でライセンスされています。
